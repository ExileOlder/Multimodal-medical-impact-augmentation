# 评估指标指南

本文档详细说明医学影像增广系统的评估指标及其使用方法。

## 📊 评估指标概览

本系统提供两类评估指标：

1. **图像质量指标**：评估生成图像与参考图像的相似度
2. **结构一致性指标**：评估生成图像的病灶区域是否与输入掩码一致

## 1. 图像质量指标

### 1.1 PSNR (Peak Signal-to-Noise Ratio)

**定义**：峰值信噪比，衡量图像的失真程度。

**计算公式**：
```
PSNR = 20 * log10(MAX_PIXEL_VALUE / sqrt(MSE))
```

**取值范围**：
- 理论范围：0 到 +∞ dB
- 实际范围：通常 20-50 dB

**评价标准**：
- **>40 dB**：优秀，几乎无失真
- **30-40 dB**：良好，轻微失真
- **20-30 dB**：可接受，明显失真
- **<20 dB**：较差，严重失真

**适用场景**：
- 评估像素级的重建质量
- 对比不同生成方法的性能
- 医学影像中，PSNR >30 dB 通常表示可接受的质量

**局限性**：
- 不能完全反映人眼感知质量
- 对结构性失真不敏感

### 1.2 SSIM (Structural Similarity Index)

**定义**：结构相似性指数，衡量图像的结构信息保持程度。

**计算公式**：
```
SSIM = (2*μx*μy + C1)(2*σxy + C2) / ((μx² + μy² + C1)(σx² + σy² + C2))
```
其中：
- μx, μy：图像均值
- σx, σy：图像标准差
- σxy：协方差
- C1, C2：稳定常数

**取值范围**：
- 理论范围：-1 到 1
- 实际范围：0 到 1（医学影像）

**评价标准**：
- **>0.95**：优秀，结构高度相似
- **0.85-0.95**：良好，结构基本一致
- **0.70-0.85**：可接受，结构有差异
- **<0.70**：较差，结构差异明显

**适用场景**：
- 评估结构性特征的保持
- 更符合人眼感知
- 医学影像中，SSIM >0.85 通常表示良好的结构保持

**优势**：
- 考虑了亮度、对比度和结构三个维度
- 更接近人眼的感知质量

### 1.3 MAE (Mean Absolute Error)

**定义**：平均绝对误差，衡量像素值的平均偏差。

**计算公式**：
```
MAE = mean(|img1 - img2|)
```

**取值范围**：
- 0 到 255（8-bit 图像）
- 0 表示完全相同

**评价标准**：
- **<5**：优秀
- **5-15**：良好
- **15-30**：可接受
- **>30**：较差

**适用场景**：
- 简单直观的误差度量
- 对异常值不敏感（相比 MSE）

### 1.4 MSE (Mean Squared Error)

**定义**：均方误差，衡量像素值的平方偏差。

**计算公式**：
```
MSE = mean((img1 - img2)²)
```

**取值范围**：
- 0 到 65025（8-bit 图像）
- 0 表示完全相同

**评价标准**：
- **<100**：优秀
- **100-500**：良好
- **500-1000**：可接受
- **>1000**：较差

**适用场景**：
- PSNR 的基础计算
- 对大误差更敏感

## 2. 结构一致性指标

### 2.1 Dice Coefficient (Dice 系数)

**定义**：衡量两个区域的重叠程度，也称为 F1 Score。

**计算公式**：
```
Dice = 2 * |A ∩ B| / (|A| + |B|)
```
其中：
- A：生成图像的病灶区域
- B：输入掩码的病灶区域
- ∩：交集
- |·|：区域面积

**取值范围**：
- 0 到 1
- 1 表示完美匹配

**评价标准**：
- **>0.9**：优秀，几乎完美匹配
- **0.7-0.9**：良好，高度一致
- **0.5-0.7**：可接受，基本一致
- **<0.5**：较差，一致性不足

**适用场景**：
- 医学影像分割评估的标准指标
- 评估生成图像的病灶位置是否准确
- 验证模型是否学习到正确的空间结构

**重要性**：
- 对于医学影像增广，Dice >0.7 是基本要求
- 确保生成的病灶区域忠实于输入掩码
- 避免生成错误位置或形状的病灶

### 2.2 IoU (Intersection over Union)

**定义**：交并比，也称为 Jaccard Index。

**计算公式**：
```
IoU = |A ∩ B| / |A ∪ B|
```
其中：
- A：生成图像的病灶区域
- B：输入掩码的病灶区域
- ∩：交集
- ∪：并集

**取值范围**：
- 0 到 1
- 1 表示完美匹配

**评价标准**：
- **>0.8**：优秀，几乎完美匹配
- **0.5-0.8**：良好，高度一致
- **0.3-0.5**：可接受，基本一致
- **<0.3**：较差，一致性不足

**适用场景**：
- 目标检测和分割的标准指标
- 比 Dice 系数更严格（对小区域更敏感）
- 评估病灶区域的精确匹配度

**与 Dice 的关系**：
```
Dice = 2 * IoU / (1 + IoU)
IoU = Dice / (2 - Dice)
```

**选择建议**：
- Dice 系数对小区域更友好
- IoU 对大区域更严格
- 两者结合使用可以全面评估

## 3. 使用方法

### 3.1 仅评估图像质量

```bash
python evaluate.py \
    --generated results/generated_images/ \
    --reference data/reference_images/ \
    --output results/quality_evaluation.json
```

**输出示例**：
```
======================================================================
EVALUATION SUMMARY
======================================================================
Number of images: 100

【图像质量指标】
PSNR: 32.45 ± 2.31 dB
  Range: [28.12, 36.78]

SSIM: 0.8923 ± 0.0456
  Range: [0.7834, 0.9512]

MAE: 12.34 ± 3.21
MSE: 234.56 ± 45.67
======================================================================
```

### 3.2 评估图像质量 + 结构一致性

```bash
python evaluate.py \
    --generated results/generated_images/ \
    --reference data/reference_images/ \
    --masks data/input_masks/ \
    --evaluate-structure \
    --output results/full_evaluation.json
```

**输出示例**：
```
======================================================================
EVALUATION SUMMARY
======================================================================
Number of images: 100

【图像质量指标】
PSNR: 32.45 ± 2.31 dB
  Range: [28.12, 36.78]

SSIM: 0.8923 ± 0.0456
  Range: [0.7834, 0.9512]

MAE: 12.34 ± 3.21
MSE: 234.56 ± 45.67

【结构一致性指标】
Dice Coefficient: 0.7845 ± 0.0623
  Range: [0.6234, 0.8912]
  (1.0 = 完美匹配, >0.7 = 良好, >0.5 = 可接受)

IoU (Jaccard Index): 0.6523 ± 0.0734
  Range: [0.4567, 0.7823]
  (1.0 = 完美匹配, >0.5 = 良好, >0.3 = 可接受)
======================================================================
```

### 3.3 自定义文件模式

```bash
python evaluate.py \
    --generated results/generated_images/ \
    --reference data/reference_images/ \
    --masks data/input_masks/ \
    --evaluate-structure \
    --pattern "*.jpg" \
    --output results/evaluation_jpg.json
```

## 4. 病灶掩码提取方法

系统提供三种从生成图像中提取病灶掩码的方法：

### 4.1 红色通道法（默认）

**原理**：医学影像中的病灶通常呈红色（如眼底图像的出血、渗出）。

**适用场景**：
- 眼底图像（糖尿病视网膜病变）
- 皮肤病变图像
- 其他红色病灶

**参数**：
```python
mask = extract_lesion_mask_from_image(
    image,
    method="red_channel",
    threshold=0.5  # 红色通道阈值
)
```

### 4.2 饱和度法

**原理**：病灶区域通常具有较高的颜色饱和度。

**适用场景**：
- 色彩鲜艳的病灶
- 炎症区域
- 血管异常

**参数**：
```python
mask = extract_lesion_mask_from_image(
    image,
    method="saturation",
    threshold=0.5  # HSV 饱和度阈值
)
```

### 4.3 亮度法

**原理**：病灶区域通常比背景更暗或更亮。

**适用场景**：
- CT/MRI 图像
- X 光图像
- 亮度对比明显的病灶

**参数**：
```python
mask = extract_lesion_mask_from_image(
    image,
    method="brightness",
    threshold=0.5  # 亮度阈值
)
```

### 4.4 自定义提取方法

如果默认方法不适用，可以自定义提取逻辑：

```python
import numpy as np
from PIL import Image

def custom_extract_mask(image_path, threshold=0.5):
    """自定义病灶掩码提取方法"""
    image = np.array(Image.open(image_path))
    
    # 示例：使用绿色通道
    green_channel = image[:, :, 1] / 255.0
    mask = (green_channel > threshold).astype(np.uint8) * 255
    
    return mask

# 使用自定义方法
mask = custom_extract_mask("generated.png", threshold=0.6)
```

## 5. 评估结果解读

### 5.1 理想结果

**图像质量**：
- PSNR >35 dB
- SSIM >0.90
- MAE <10
- MSE <200

**结构一致性**：
- Dice >0.80
- IoU >0.65

**解读**：生成图像质量优秀，病灶区域与输入掩码高度一致，可用于下游任务。

### 5.2 良好结果

**图像质量**：
- PSNR 30-35 dB
- SSIM 0.85-0.90
- MAE 10-15
- MSE 200-500

**结构一致性**：
- Dice 0.70-0.80
- IoU 0.50-0.65

**解读**：生成图像质量良好，病灶区域基本一致，可用于数据增广。

### 5.3 可接受结果

**图像质量**：
- PSNR 25-30 dB
- SSIM 0.75-0.85
- MAE 15-25
- MSE 500-1000

**结构一致性**：
- Dice 0.60-0.70
- IoU 0.40-0.50

**解读**：生成图像质量可接受，但需要进一步优化模型或调整参数。

### 5.4 不理想结果

**图像质量**：
- PSNR <25 dB
- SSIM <0.75
- MAE >25
- MSE >1000

**结构一致性**：
- Dice <0.60
- IoU <0.40

**解读**：生成图像质量不足，需要重新训练模型或检查数据质量。

## 6. 常见问题

### Q1: 为什么需要结构一致性评估？

**A**: 对于医学影像增广，仅评估图像质量（PSNR/SSIM）是不够的。我们还需要确保：
- 生成的病灶位置与输入掩码一致
- 病灶的形状和大小符合预期
- 模型学习到了正确的空间结构

结构一致性评估（Dice/IoU）可以验证这些关键特性。

### Q2: Dice 和 IoU 哪个更重要？

**A**: 两者都重要，但侧重点不同：
- **Dice 系数**：对小区域更友好，适合评估小病灶
- **IoU**：更严格，适合评估大病灶或整体匹配度

建议同时使用两者，全面评估结构一致性。

### Q3: 如何提高结构一致性？

**A**: 如果 Dice/IoU 较低，可以尝试：
1. 增加掩码条件的权重
2. 使用更大的批次大小
3. 延长训练时间
4. 检查掩码数据质量
5. 调整病灶提取方法的阈值

### Q4: 不同医学影像的评估标准是否相同？

**A**: 基本相同，但具体阈值可能需要调整：
- **眼底图像**：PSNR >30 dB, Dice >0.7
- **CT/MRI**：PSNR >35 dB, Dice >0.75（对比度更高）
- **病理切片**：PSNR >32 dB, Dice >0.7（细节更丰富）

建议根据具体任务和数据特点调整评估标准。

### Q5: 如何选择病灶提取方法？

**A**: 根据医学影像类型选择：
- **眼底图像**：红色通道法（病灶呈红色）
- **CT/MRI**：亮度法（病灶与背景对比明显）
- **彩色病理切片**：饱和度法（病灶颜色鲜艳）

如果默认方法效果不佳，可以自定义提取逻辑。

## 7. 参考文献

1. Wang, Z., et al. (2004). "Image quality assessment: from error visibility to structural similarity." IEEE TIP.
2. Dice, L. R. (1945). "Measures of the amount of ecologic association between species." Ecology.
3. Jaccard, P. (1912). "The distribution of the flora in the alpine zone." New Phytologist.

## 8. 总结

本系统提供了全面的评估指标：
- **图像质量指标**（PSNR/SSIM/MAE/MSE）评估生成图像的整体质量
- **结构一致性指标**（Dice/IoU）评估病灶区域的空间一致性

两类指标结合使用，可以全面评估医学影像增广系统的性能，确保生成的图像既具有高质量，又具有正确的病灶结构。
